<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
				<title>Local AI Stack Interface</title>
				<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
	<body>
		<header>
			<div class="container">
				<div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
					<h1>Local AI Stack</h1>
					<div class="header-links" style="display: flex; align-items: center; gap: 15px;">
						<a href="https://github.com/trevino293/local_ai_stack" target="_blank" style="
							display: flex;
							align-items: center;
							gap: 8px;
							color: var(--text-primary);
							text-decoration: none;
							padding: 8px 12px;
							border-radius: 5px;
							border: 1px solid var(--border-color);
							background: var(--bg-tertiary);
							transition: all 0.3s;
							font-size: 0.9rem;
						" onmouseover="this.style.background='var(--accent-blue)'; this.style.borderColor='var(--accent-blue)';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
								<path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
							</svg>
							GitHub
						</a>
						<a href="/docs" style="
							display: flex;
							align-items: center;
							gap: 8px;
							color: var(--text-primary);
							text-decoration: none;
							padding: 8px 12px;
							border-radius: 5px;
							border: 1px solid var(--border-color);
							background: var(--bg-tertiary);
							transition: all 0.3s;
							font-size: 0.9rem;
						" onmouseover="this.style.background='var(--accent-blue)'; this.style.borderColor='var(--accent-blue)';" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.borderColor='var(--border-color)';">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
								<path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
							</svg>
							Docs
						</a>
					</div>
				</div>
			</div>
		</header>

		<div class="container">
			<div class="main-grid">
				<!-- Left Panel: Model & File Management -->
				<div class="panel">
					<h2>Model & Configuration</h2>
					<div class="model-header">
						<select id="modelSelect" class="model-select">
							<option value="">Loading models...</option>
						</select>
						<div class="config-button">
							<button class="gear-btn" id="configToggle">
								<svg class="gear-icon" viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
								</svg>
							</button>
							<div class="config-dropdown" id="configDropdown">
								<div class="config-header">
									<span class="config-title">Model Parameters</span>
								</div>

								<div class="preset-controls">
									<button class="preset-btn" data-preset="creative">Creative</button>
									<button class="preset-btn" data-preset="balanced">Balanced</button>
									<button class="preset-btn" data-preset="precise">Precise</button>
								</div>

								<div class="saved-configs">
									<div class="saved-configs-header">
										<span class="saved-configs-title">Saved Configurations</span>
										<button class="config-new-btn" id="newConfigBtn">+ New</button>
									</div>
									<div class="saved-configs-list" id="savedConfigsList">
										<p class="no-configs">No saved configurations</p>
									</div>
								</div>

								<div class="config-save-section" id="configSaveSection" style="display: none;">
									<div class="config-save-input">
										<input type="text" id="configNameInput" placeholder="Configuration name..." maxlength="50">
											<div class="config-save-actions">
												<button class="config-save-btn" id="saveNewConfigBtn">Save</button>
												<button class="config-cancel-btn" id="cancelSaveBtn">Cancel</button>
											</div>
										</div>
								</div>

								<div class="param-group">
									<label for="temperature">
										Temperature: <span class="param-value" id="temperatureValue">0.70</span>
									</label>
									<input type="range" id="temperature" min="0" max="2" step="0.01" value="0.7">
										<small>Controls randomness (0=deterministic, 2=very creative)</small>
									</div>

								<div class="param-group">
									<label for="top_p">
										Top P: <span class="param-value" id="topPValue">0.90</span>
									</label>
									<input type="range" id="top_p" min="0" max="1" step="0.01" value="0.9">
										<small>Nucleus sampling threshold</small>
									</div>

								<div class="param-group">
									<label for="top_k">
										Top K: <span class="param-value" id="topKValue">40</span>
									</label>
									<input type="range" id="top_k" min="1" max="100" step="1" value="40">
										<small>Limits vocabulary to top K tokens</small>
									</div>

								<div class="param-group">
									<label for="repeat_penalty">
										Repeat Penalty: <span class="param-value" id="repeatPenaltyValue">1.10</span>
									</label>
									<input type="range" id="repeat_penalty" min="0.5" max="2" step="0.01" value="1.1">
										<small>Penalizes repetition (1=no penalty)</small>
									</div>

								<div class="param-group">
									<label for="seed">
										Seed: <span class="param-value" id="seedValue">Random</span>
									</label>
									<input type="number" id="seed" min="-1" max="999999" value="-1">
										<small>-1 for random, set for reproducible output</small>
									</div>

								<div class="param-group">
									<label for="num_predict">
										Max Tokens: <span class="param-value" id="numPredictValue">Auto</span>
									</label>
									<input type="number" id="num_predict" min="-1" max="4096" value="-1">
										<small>-1 for auto, limit response length</small>
									</div>

								<div class="config-actions">
									<button class="save-btn" id="saveParams">Save</button>
									<button class="reset-btn" id="resetParams">Reset</button>
								</div>
							</div>
						</div>
					</div>

					<h2>System Status</h2>
					<div class="status">
						<span class="status-dot" id="ollamaDot"></span>
						<span>
							Ollama: <span id="ollamaStatus">Checking...</span>
						</span>
					</div>
					<div class="status">
						<span class="status-dot" id="mcpDot"></span>
						<span>
							MCP Server: <span id="mcpStatus">Checking...</span>
						</span>
					</div>

					<h2>Context Files</h2>
					<div class="file-upload">
						<div class="file-input-wrapper">
							<input type="file" id="fileInput" accept=".txt,.md,.json,.csv">
								<label for="fileInput" class="file-input-label">Upload File</label>
							</div>
					</div>
					<div id="fileList" class="file-list">
						<p>No files uploaded</p>
					</div>
				</div>

				<!-- Center: Chat Interface -->
				<div class="panel chat-container">
					<h2>Chat Interface</h2>
					<div id="chatMessages" class="chat-messages">
						<div class="message assistant">
							<div class="message-header">
								<span>Assistant</span>
								<span>Ready</span>
							</div>
							<div class="message-content">Hello! I'm your local AI assistant with enhanced reasoning capabilities and conversation memory. Select a model and configure parameters using the gear icon, then start chatting. Upload context files to enhance our conversations. I'll show you my thought process, confidence levels, and maintain context throughout our conversation.</div>
						</div>
					</div>
					<div class="chat-input">
						<textarea id="messageInput" placeholder="Type your message here... (Ctrl+Enter to send)"></textarea>
						<button id="sendButton">Send</button>
					</div>
				</div>

				<!-- Right Panel: Chat History & Conversation Management -->
				<div class="panel">
					<div class="history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
						<h2 style="margin: 0;">Chat History</h2>
						<button id="clearHistoryBtn" style="
							background: var(--error);
							color: white;
							border: none;
							padding: 6px 12px;
							border-radius: 4px;
							cursor: pointer;
							font-size: 0.8rem;
							transition: background 0.3s;
						" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='var(--error)'">
							Clear All
						</button>
					</div>

					<div class="conversation-info" style="
						background: var(--bg-tertiary);
						padding: 10px;
						border-radius: 6px;
						margin-bottom: 15px;
						border: 1px solid var(--border-color);
					">
						<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">
							Current Conversation
						</div>
						<div id="conversationStatus" style="font-size: 0.9rem; color: var(--text-primary);">
							Active Session
						</div>
					</div>

					<div id="historyList" class="history-list">
						<p>No chat history yet</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			// Global function to handle deliberation toggle
			function toggleDeliberation(button) {
			const content = button.closest('.deliberation-section').querySelector('.deliberation-content');
			const icon = button.querySelector('.chevron-icon');

			content.classList.toggle('collapsed');
			icon.style.transform = content.classList.contains('collapsed') ? '' : 'rotate(180deg)';
			}

			// Add clear history functionality
			document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('clearHistoryBtn').addEventListener('click', async function() {
			if (confirm('Clear all chat history? This action cannot be undone.')) {
			try {
			const response = await fetch('/api/chat/history', {
			method: 'DELETE'
			});

			if (response.ok) {
			document.getElementById('historyList').innerHTML = '<p>No chat history yet</p>';
			document.getElementById('chatMessages').innerHTML = `
			<div class="message assistant">
				<div class="message-header">
					<span>Assistant</span>
					<span>Ready</span>
				</div>
				<div class="message-content">Chat history cleared. How can I help you?</div>
			</div>
			`;
			// Reset conversation state
			currentConversationId = 'default';
			conversationState = 'new';
			updateConversationUI();
			} else {
			alert('Failed to clear chat history');
			}
			} catch (error) {
			console.error('Error clearing history:', error);
			alert('Error occurred while clearing history');
			}
			}
			});
			});
		</script>
		<script src="{{ url_for('static', filename='js/main.js') }}"></script>
	</body>
</html>